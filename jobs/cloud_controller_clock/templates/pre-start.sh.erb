#!/usr/bin/env bash

set -ex

mkdir -p "/var/vcap/data/cloud_controller_clock/tmp"
chown vcap:vcap "/var/vcap/data/cloud_controller_clock/tmp"

BUNDLER_DIR=/var/vcap/data/cloud_controller_clock/tmp/bundler
chpst -u vcap:vcap mkdir -p $BUNDLER_DIR
chpst -u vcap:vcap chmod -R go-w $BUNDLER_DIR

source /var/vcap/packages/capi_utils/syslog_utils.sh
tee_output_to_sys_log "cloud_controller_clock.$(basename "$0")"

function setup_directories {
  RUN_DIR="/var/vcap/sys/run/cloud_controller_clock"
  LOG_DIR="/var/vcap/sys/log/cloud_controller_clock"

  mkdir -p "$RUN_DIR"
  mkdir -p "$LOG_DIR"

  chown -R vcap:vcap "$RUN_DIR"
  chown -R vcap:vcap "$LOG_DIR"
}

write_blobstore_scope_configs() {
  local cfg_json="${CONFIG_DIR}/blobstore_configs.json"
  if [[ ! -f "$cfg_json" ]]; then
    echo "blobstore_configs.json not found at $cfg_json; skipping fan-out"
    return 0
  fi

  # Use the packaged Ruby if you prefer; system Ruby is usually fine on CF VMs.
  CFG="$cfg_json" DEST="$BUNDLER_DIR" ruby <<'RUBY'
  require "json"
  cfg_path = ENV.fetch("CFG")
  dest     = ENV.fetch("DEST")
  data = JSON.parse(File.read(cfg_path))

  %w[buildpacks droplets packages resource_pool].each do |k|
    out = File.join(dest, "storage_cli_config_#{k}.json")
    File.write(out, JSON.pretty_generate(data[k] || {}))
  end
RUBY
}

function main {
  setup_directories
  write_blobstore_scope_configs
}

main

exit 0
