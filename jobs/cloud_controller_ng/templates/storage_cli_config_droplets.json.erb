<%
require "json"

 # Ensure Azure CLI connection_config has a default timeout if none is set
def cli_cfg_with_default_timeout(connection_cfg, blobstore_type, default_seconds: 41)
  cfg = (connection_cfg || {}).dup
  if blobstore_type == 'storage_cli'
    if !cfg.key?('put_timeout_in_seconds') || cfg['put_timeout_in_seconds'].to_s.empty?
      cfg['put_timeout_in_seconds'] = default_seconds.to_s
    end
  end
  cfg
end

# add key only when value is present
def add(h, key, val)
  return if val.nil?
  return if val.respond_to?(:empty?) && val.empty?
  h[key] = val
end

# merge optional custom flags into options
def apply_custom!(options, custom)
  return unless custom.respond_to?(:each)
  custom.each { |k, v| add(options, k.to_s, v) }
end

def apply_custom_from_props!(options, scope)
  begin
    custom = p("#{scope}.custom", {})
    apply_custom!(options, custom)
  rescue
    # ignore if property not defined
  end
end
scope = "cc.droplets.connection_config"
provider = p("cc.droplets.blobstore_provider", nil)

if provider == "AzureRM"
  options = {}
  options["provider"] = provider
  options["account_name"]   = p("#{scope}.azure_storage_account_name")
  options["container_name"] = p("#{scope}.container_name")
  options["account_key"] = p("#{scope}.azure_storage_access_key")
  add(options, "environment",        p("#{scope}.environment", "AzureCloud"))
  add(options, "put_timeout_in_seconds", p("#{scope}.put_timeout_in_seconds", nil))

  apply_custom_from_props!(options, scope)
  options = cli_cfg_with_default_timeout(options, 'storage_cli')
elsif provider == "aliyun"
  options = {}
  options["provider"] = provider
  options["access_key_id"] = p("#{scope}.aliyun_accesskey_id")
  options["access_key_secret"] = p("#{scope}.aliyun_accesskey_secret")
  options["endpoint"] = p("#{scope}.aliyun_oss_endpoint")
  options["bucket_name"] = p("#{scope}.aliyun_oss_bucket")
  add(options, "region_id",            p("#{scope}.aliyun_region_id", nil))

  apply_custom_from_props!(options, scope)
else
  options = {} # for now: all non-azure and non-aliyun providers output an empty JSON object
end
-%>
<%= JSON.pretty_generate(options) %>