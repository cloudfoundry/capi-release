<%
require "json"

def cli_cfg_with_default_timeout(connection_cfg, blobstore_type, default_seconds: 41)
  cfg = (connection_cfg || {}).dup
  if blobstore_type == 'storage_cli'
    if !cfg.key?('put_timeout_in_seconds') || cfg['put_timeout_in_seconds'].to_s.empty?
      cfg['put_timeout_in_seconds'] = default_seconds.to_s
    end
  end
  cfg
end

def add(h, key, val)
  return if val.nil?
  return if val.respond_to?(:empty?) && val.empty?
  h[key] = val
end

def options_for(scope_prefix, provider_prop)
  provider = p(provider_prop, nil)
  if provider != "AzureRM"
    {} # for now: all non-azure providers output an empty JSON object
  else
    h = {}
    h["provider"]       = provider
    h["account_name"]   = p("#{scope_prefix}.azure_storage_account_name")
    h["container_name"] = p("#{scope_prefix}.container_name")
    add(h, "account_key",            p("#{scope_prefix}.azure_storage_access_key"))
    add(h, "environment",            p("#{scope_prefix}.environment", "AzureCloud"))
    add(h, "put_timeout_in_seconds", p("#{scope_prefix}.put_timeout_in_seconds", nil))

    # optional passthrough for extra storage-cli flags
    begin
      custom = p("#{scope_prefix}.custom", {})
      if custom.respond_to?(:each)
        custom.each { |k, v| add(h, k.to_s, v) }
      end
    rescue
      # property might not exist; ignore
    end

    cli_cfg_with_default_timeout(h, 'storage_cli')
  end
end

all = {
  "buildpacks"    => options_for("cc.buildpacks.connection_config",    "cc.buildpacks.blobstore_provider"),
  "droplets"      => options_for("cc.droplets.connection_config",      "cc.droplets.blobstore_provider"),
  "packages"      => options_for("cc.packages.connection_config",      "cc.packages.blobstore_provider"),
  "resource_pool" => options_for("cc.resource_pool.connection_config", "cc.resource_pool.blobstore_provider"),
}
-%>
<%= JSON.pretty_generate(all) %>