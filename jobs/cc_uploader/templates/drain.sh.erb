#!/usr/bin/env bash

LOG_FILE="/var/vcap/sys/log/cc_uploader/drain.log"
PID_FILE="/var/vcap/sys/run/bpm/cc_uploader/cc_uploader.pid"

TIMEOUT_MINUTES="<%= p("capi.cc_uploader.cc_uploader_drain_timeout_in_minutes") %>"

TIMEOUT_MINUTES="${TIMEOUT_MINUTES%m}"

DRAIN_TIMEOUT_IN_SECONDS=$(( TIMEOUT_MINUTES * 60 ))
START_TS=$(date +%s)

echo "$(date): cc_uploader drain starting (timeout ${DRAIN_TIMEOUT_IN_SECONDS}s)" >> "$LOG_FILE"

if [ -f "$PID_FILE" ]; then
  kill -TERM "$(cat "$PID_FILE")"
  while kill -0 "$(cat "$PID_FILE")" >/dev/null 2>&1; do
    NOW_TS=$(date +%s)
    ELAPSED=$(( NOW_TS - START_TS ))
    if [ "$ELAPSED" -ge "$DRAIN_TIMEOUT_IN_SECONDS" ]; then
      echo "$(date): drain timeout reached after ${DRAIN_TIMEOUT_IN_SECONDS}s" >> "$LOG_FILE"
      break
    fi
    echo "$(date): waiting for cc_uploader (elapsed ${ELAPSED}s)" >> "$LOG_FILE"
    sleep 1
  done
fi

echo "$(date): drain complete, returning 0 to BOSH" >> "$LOG_FILE"
echo 0
exit 0

