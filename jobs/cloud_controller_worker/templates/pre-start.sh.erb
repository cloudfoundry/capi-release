#!/usr/bin/env bash

set -ex

source /var/vcap/packages/capi_utils/syslog_utils.sh
tee_output_to_sys_log "cloud_controller_worker.$(basename "$0")"

source /var/vcap/jobs/cloud_controller_worker/bin/setup_local_blobstore.sh

SCRIPT_DIR="$(dirname "${BASH_SOURCE[0]}")"

function setup_directories {
  setup_local_blobstore

  mkdir -p "/var/vcap/sys/run/cloud_controller_worker"
  chown -R vcap:vcap "/var/vcap/sys/run/cloud_controller_worker"

  mkdir -p "/var/vcap/sys/log/cloud_controller_worker"
  chown -R vcap:vcap "/var/vcap/sys/log/cloud_controller_worker"

  mkdir -p "<%= p("cc.directories.tmpdir") %>"
  chown vcap:vcap "<%= p("cc.directories.tmpdir") %>"

  BUNDLER_DIR="<%= p("cc.directories.tmpdir") %>/bundler"
  chpst -u vcap:vcap mkdir -p $BUNDLER_DIR
  chpst -u vcap:vcap chmod -R go-w $BUNDLER_DIR
}

CONFIG_DIR="/var/vcap/jobs/cloud_controller_worker/config"

ruby_cmd="${RUBY_CMD:-}"
if [[ -z "$ruby_cmd" ]]; then ruby_cmd="$(ls -1 /var/vcap/packages/ruby*/bin/ruby 2>/dev/null | sort -V | tail -n1 || true)"; fi
if [[ -z "$ruby_cmd" ]]; then
  echo "ERROR: No ruby found (set RUBY_CMD or ensure /var/vcap/packages/ruby*/bin/ruby exists)"
  exit 1
fi

write_blobstore_configs() {
  local cfg_json="${CONFIG_DIR}/blobstore_configs.json"
  if [[ ! -f "$cfg_json" ]]; then
    echo "blobstore_configs.json not found at $cfg_json;"
    return 0
  fi

  BLOBSTORE_INPUT_CONFIG="$cfg_json" BLOBSTORE_OUTPUT_CONFIG="${CONFIG_DIR}" "$ruby_cmd"  <<'RUBY'
  require "json"
  cfg_path = ENV.fetch("BLOBSTORE_INPUT_CONFIG")
  dest     = ENV.fetch("BLOBSTORE_OUTPUT_CONFIG")
  data = JSON.parse(File.read(cfg_path))

  %w[buildpacks droplets packages resource_pool].each do |k|
    out = File.join(dest, "storage_cli_config_#{k}.json")
    File.write(out, JSON.pretty_generate(data[k] || {}))
  end
RUBY
}

function main {
  setup_directories
  write_blobstore_configs
}

main

exit 0
